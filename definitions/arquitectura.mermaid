flowchart TB
    subgraph Usuario["ğŸ‘¤ Usuario"]
        User[Usuario DSI]
    end
    
    subgraph Orquestacion["ğŸ¯ Capa de OrquestaciÃ³n"]
        N8N[n8n Workflow<br/>â”â”â”â”â”â”â”â”â”â”â”â”<br/>â€¢ Webhook Manual<br/>â€¢ GeneraciÃ³n de run_id<br/>â€¢ ConstrucciÃ³n de payload]
    end
    
    subgraph MessageBroker["ğŸ“¬ Message Broker"]
        RMQ[RabbitMQ<br/>â”â”â”â”â”â”â”â”â”â”â”â”<br/>Exchange: rpa.direct<br/>Queue: rpa.cuentas.normalizar.v1<br/>Routing Key: rpa.cuentas.normalizar.v1]
    end
    
    subgraph RPABot["ğŸ¤– RPA Bot Python"]
        Consumer[Consumer<br/>â”â”â”â”â”â”â”â”<br/>â€¢ Escucha cola<br/>â€¢ Valida payload<br/>â€¢ Maneja ACK/NACK]
        
        Processor[Processor<br/>â”â”â”â”â”â”â”â”<br/>â€¢ Lee CSV<br/>â€¢ Normaliza campos<br/>â€¢ Valida registros<br/>â€¢ Calcula mÃ©tricas]
        
        Logger[DSI Logger<br/>â”â”â”â”â”â”â”â”<br/>â€¢ Logs estructurados<br/>â€¢ JSON por lÃ­nea<br/>â€¢ Contexto run_id]
        
        Models[Models<br/>â”â”â”â”â”â”â”â”<br/>â€¢ ValidaciÃ³n Pydantic<br/>â€¢ Tipos de datos<br/>â€¢ Reglas de negocio]
        
        Consumer --> Processor
        Consumer --> Logger
        Processor --> Logger
        Processor --> Models
    end
    
    subgraph Storage["ğŸ’¾ Almacenamiento"]
        InputData[(data/<br/>cuentas.csv)]
        OutputData[(out/<br/>â”â”â”â”â”â”â”â”<br/>â€¢ cuentas_normalizadas.csv<br/>â€¢ metrics.json<br/>â€¢ error_report.json<br/>â€¢ logs.jsonl)]
    end
    
    subgraph Observability["ğŸ“Š Observabilidad"]
        Promtail[Promtail<br/>â”â”â”â”â”â”â”â”<br/>â€¢ Lee logs.jsonl<br/>â€¢ Pipeline parsing]
        
        Loki[Loki<br/>â”â”â”â”â”â”â”â”<br/>â€¢ Almacena logs<br/>â€¢ IndexaciÃ³n]
        
        Grafana[Grafana<br/>â”â”â”â”â”â”â”â”<br/>â€¢ Dashboard<br/>â€¢ VisualizaciÃ³n<br/>â€¢ Alertas]
        
        Promtail --> Loki
        Loki --> Grafana
    end
    
    User -->|Activa webhook| N8N
    N8N -->|Publica mensaje JSON| RMQ
    RMQ -->|Consume mensaje| Consumer
    
    InputData -.->|Lee| Processor
    Processor -->|Escribe| OutputData
    Logger -->|Escribe| OutputData
    
    OutputData -.->|Monitorea| Promtail
    
    classDef userStyle fill:#E8F5E9,stroke:#4CAF50,stroke-width:3px
    classDef orchStyle fill:#E3F2FD,stroke:#2196F3,stroke-width:3px
    classDef brokerStyle fill:#FFF3E0,stroke:#FF9800,stroke-width:3px
    classDef botStyle fill:#F3E5F5,stroke:#9C27B0,stroke-width:3px
    classDef storageStyle fill:#EFEBE9,stroke:#795548,stroke-width:3px
    classDef obsStyle fill:#E0F2F1,stroke:#009688,stroke-width:3px
    
    class Usuario userStyle
    class Orquestacion orchStyle
    class MessageBroker brokerStyle
    class RPABot botStyle
    class Storage storageStyle
    class Observability obsStyle